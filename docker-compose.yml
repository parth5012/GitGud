version: "3.9"

services:

  # ──────────────────────────────────────────
  # Redis – message broker for Celery
  # ──────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: gitgud_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ──────────────────────────────────────────
  # App – interactive CLI / Textual TUI
  # ──────────────────────────────────────────
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: gitgud_app
    restart: unless-stopped
    stdin_open: true   # keeps STDIN open so the CLI can accept input
    tty: true          # allocates a pseudo-TTY for Textual / colorama
    env_file:
      - .env
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    volumes:
      - ./codebases:/usr/src/app/codebases   # persist fetched repo snapshots
    depends_on:
      redis:
        condition: service_healthy

  # ──────────────────────────────────────────
  # Celery beat for task execution after certain time interval.
  # ──────────────────────────────────────────
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: gitgud_worker
    restart: unless-stopped
    command: celery -A beat worker --loglevel=info
    env_file:
      - .env
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    volumes:
      - ./codebases:/usr/src/app/codebases
    depends_on:
      redis:
        condition: service_healthy
  # ──────────────────────────────────────────
  # Celery beat for task execution after certain time interval.
  # ──────────────────────────────────────────
  beat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: gitgud_beat
    restart: unless-stopped
    command: celery -A beat beat --loglevel=info
    env_file:
      - .env
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    volumes:
      - ./codebases:/usr/src/app/codebases
    depends_on:
      redis:
        condition: service_healthy
